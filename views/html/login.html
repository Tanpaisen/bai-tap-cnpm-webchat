<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Đăng nhập & Đăng ký</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js for 3D Effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
            colors: {
              brand: {
                dark: "#0a0a0a",
                card: "#111111",
                input: "#1a1a1a",
                purple: "#6d28d9",
                purpleHover: "#5b21b6",
                text: "#e5e5e5",
                muted: "#a3a3a3",
              },
            },
            boxShadow: {
              glow: "0 0 20px rgba(109, 40, 217, 0.5)",
            },
          },
        },
      };
    </script>
    <style>
      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #111;
      }
      ::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 4px;
      }

      /* Animations */
      .fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .hidden-tab {
        display: none;
      }
      .active-tab-btn {
        border-bottom: 2px solid #8b5cf6;
        color: white;
      }
      .inactive-tab-btn {
        border-bottom: 2px solid transparent;
        color: #737373;
      }
    </style>
  </head>

  <body
    class="bg-black text-brand-text flex items-center justify-center min-h-screen p-4"
  >
    <!-- Main Container -->
    <div
      class="w-full max-w-4xl bg-brand-card rounded-2xl shadow-glow border border-zinc-800 overflow-hidden flex flex-col md:flex-row h-auto md:h-[600px]"
    >
      <!-- LEFT SIDE: 3D Visualization -->
      <div
        class="w-full md:w-1/2 relative bg-black flex items-center justify-center overflow-hidden group"
      >
        <!-- 3D Canvas Container -->
        <div
          id="canvas-container"
          class="absolute inset-0 z-0 cursor-move"
        ></div>

        <!-- Overlay Gradient for readability -->
        <div
          class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-black/20 pointer-events-none"
        ></div>

        <!-- Content over 3D -->
        <div
          class="relative z-10 text-center p-8 pointer-events-none select-none"
        >
          <div class="mb-4">
            <!-- Logo Icon -->
            <i
              class="fa-solid fa-earth-americas text-4xl text-violet-500 drop-shadow-[0_0_10px_rgba(139,92,246,0.8)]"
            ></i>
          </div>
          <h1
            class="text-4xl font-bold text-white mb-2 tracking-tight drop-shadow-md"
          >
            Welcome back
          </h1>
          <p class="text-brand-muted text-sm drop-shadow-sm">
            Connect to your world securely.
          </p>
        </div>
      </div>

      <!-- RIGHT SIDE: Forms -->
      <div
        class="w-full md:w-1/2 p-8 md:p-12 flex flex-col justify-center relative bg-brand-card z-20"
      >
        <!-- Header Text -->
        <div class="mb-6 text-center md:text-left">
          <p class="text-brand-purple text-sm font-semibold mb-1">
            Start your friend
          </p>
          <h2 class="text-2xl font-bold text-white">Chat app</h2>
        </div>

        <!-- Tabs Navigation -->
        <div class="flex space-x-8 mb-8 border-b border-zinc-800">
          <button
            id="tab-login"
            class="pb-2 text-sm font-medium transition-colors duration-200 active-tab-btn"
            onclick="switchTab('login')"
          >
            Login
          </button>
          <button
            id="tab-register"
            class="pb-2 text-sm font-medium transition-colors duration-200 inactive-tab-btn"
            onclick="switchTab('register')"
          >
            Sign up
          </button>
        </div>

        <!-- ERROR MESSAGES CONTAINER -->
        <div
          id="global-error"
          class="hidden bg-red-500/10 border border-red-500/50 text-red-400 px-4 py-2 rounded mb-4 text-sm flex items-center"
        >
          <i class="fa-solid fa-circle-exclamation mr-2"></i>
          <span id="error-text"></span>
        </div>

        <!-- FORM: LOGIN -->
        <div id="form-login" class="fade-in">
          <form action="/login" method="POST" class="space-y-4">
            <div>
              <label class="block text-xs text-brand-muted mb-1 font-medium"
                >Username</label
              >
              <input
                type="text"
                name="username"
                placeholder="Enter your username"
                required
                class="w-full bg-brand-input border border-zinc-700 rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-violet-500 focus:ring-1 focus:ring-violet-500 transition-all placeholder-zinc-600"
              />
            </div>
            <div>
              <label class="block text-xs text-brand-muted mb-1 font-medium"
                >Password</label
              >
              <input
                type="password"
                name="password"
                placeholder="••••••••"
                required
                class="w-full bg-brand-input border border-zinc-700 rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-violet-500 focus:ring-1 focus:ring-violet-500 transition-all placeholder-zinc-600"
              />
            </div>

            <div class="flex items-center justify-end">
              <a href="#" class="text-xs text-violet-400 hover:text-violet-300"
                >Forgot password?</a
              >
            </div>

            <button
              type="submit"
              class="w-full bg-gradient-to-r from-violet-700 to-purple-600 hover:from-violet-600 hover:to-purple-500 text-white font-semibold py-3 rounded-lg transition-all shadow-lg shadow-violet-900/20"
            >
              Login
            </button>
          </form>

          <div class="relative my-6">
            <div class="absolute inset-0 flex items-center">
              <div class="w-full border-t border-zinc-800"></div>
            </div>
            <div class="relative flex justify-center text-xs uppercase">
              <span class="bg-brand-card px-2 text-brand-muted">Or</span>
            </div>
          </div>

          <a
            href="/auth/google"
            class="w-full bg-white text-black font-medium py-2.5 rounded-lg flex items-center justify-center hover:bg-gray-100 transition-colors"
          >
            <img
              src="https://www.svgrepo.com/show/475656/google-color.svg"
              class="w-5 h-5 mr-2"
              alt="Google"
            />
            Continue with Google
          </a>

          <p class="mt-6 text-center text-xs text-brand-muted">
            Don't have an account?
            <a
              href="#"
              onclick="switchTab('register')"
              class="text-violet-400 hover:underline"
              >Sign up</a
            >
          </p>
        </div>

        <!-- FORM: REGISTER -->
        <div id="form-register" class="hidden-tab fade-in">
          <form
            action="/register"
            method="POST"
            class="space-y-4"
            id="register-form-logic"
          >
            <div>
              <label class="block text-xs text-brand-muted mb-1 font-medium"
                >Username</label
              >
              <input
                type="text"
                name="username"
                id="reg-username"
                placeholder="Choose a username"
                required
                class="w-full bg-brand-input border border-zinc-700 rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-violet-500 focus:ring-1 focus:ring-violet-500 transition-all placeholder-zinc-600"
              />
            </div>
            <div>
              <label class="block text-xs text-brand-muted mb-1 font-medium"
                >Password</label
              >
              <input
                type="password"
                name="password"
                id="reg-password"
                placeholder="Create a password"
                required
                class="w-full bg-brand-input border border-zinc-700 rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-violet-500 focus:ring-1 focus:ring-violet-500 transition-all placeholder-zinc-600"
              />
            </div>
            <div>
              <label class="block text-xs text-brand-muted mb-1 font-medium"
                >Confirm Password</label
              >
              <input
                type="password"
                name="confirmPassword"
                id="reg-confirm-password"
                placeholder="Confirm your password"
                required
                class="w-full bg-brand-input border border-zinc-700 rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-violet-500 focus:ring-1 focus:ring-violet-500 transition-all placeholder-zinc-600"
              />
            </div>

            <button
              type="submit"
              class="w-full bg-gradient-to-r from-violet-700 to-purple-600 hover:from-violet-600 hover:to-purple-500 text-white font-semibold py-3 rounded-lg transition-all shadow-lg shadow-violet-900/20 mt-2"
            >
              Create Account
            </button>
          </form>

          <p class="mt-6 text-center text-xs text-brand-muted">
            Already have an account?
            <a
              href="#"
              onclick="switchTab('login')"
              class="text-violet-400 hover:underline"
              >Login</a
            >
          </p>
        </div>
      </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
      // Hiệu ứng loading khi submit form
      const forms = document.querySelectorAll("form");
      forms.forEach((form) => {
        form.addEventListener("submit", function () {
          const btn = this.querySelector('button[type="submit"]');
          if (btn) {
            btn.innerHTML =
              '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Processing...';
            btn.disabled = true;
            btn.classList.add("opacity-75", "cursor-not-allowed");
          }
        });
      });

      // --- THREE.JS 3D ANIMATION ---
      function initThreeJS() {
        const container = document.getElementById("canvas-container");
        if (!container) return;

        // Scene setup
        const scene = new THREE.Scene();
        // Optional: Add subtle fog for depth
        scene.fog = new THREE.FogExp2(0x000000, 0.03);

        const camera = new THREE.PerspectiveCamera(
          75,
          container.clientWidth / container.clientHeight,
          0.1,
          1000
        );

        const renderer = new THREE.WebGLRenderer({
          alpha: true,
          antialias: true,
        });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);

        // Create Geometry: Abstract Particles Torus Knot
        const geometry = new THREE.TorusKnotGeometry(10, 3, 100, 16);

        // Create Particles Material
        const material = new THREE.PointsMaterial({
          color: 0x8b5cf6, // Violet color
          size: 0.15,
          transparent: true,
          opacity: 0.8,
          blending: THREE.AdditiveBlending,
        });

        const torusKnot = new THREE.Points(geometry, material);
        scene.add(torusKnot);

        camera.position.z = 25;

        // Mouse interaction variables
        let mouseX = 0;
        let mouseY = 0;
        let targetRotationX = 0;
        let targetRotationY = 0;

        // Event Listeners for Mouse
        const windowHalfX = container.clientWidth / 2;
        const windowHalfY = container.clientHeight / 2;

        container.addEventListener("mousemove", (event) => {
          mouseX =
            event.clientX -
            container.getBoundingClientRect().left -
            windowHalfX;
          mouseY =
            event.clientY - container.getBoundingClientRect().top - windowHalfY;
        });

        // Animation Loop
        const animate = function () {
          requestAnimationFrame(animate);

          // Auto rotation
          torusKnot.rotation.x += 0.002;
          torusKnot.rotation.y += 0.005;

          // Interactive rotation (smooth follow)
          targetRotationX = mouseY * 0.001;
          targetRotationY = mouseX * 0.001;

          // Subtle influence of mouse
          torusKnot.rotation.x +=
            0.05 * (targetRotationX - torusKnot.rotation.x * 0.05);
          torusKnot.rotation.y +=
            0.05 * (targetRotationY - torusKnot.rotation.y * 0.05);

          renderer.render(scene, camera);
        };

        animate();

        // Handle Resize
        window.addEventListener("resize", () => {
          // Update camera
          const width = container.clientWidth;
          const height = container.clientHeight;
          camera.aspect = width / height;
          camera.updateProjectionMatrix();
          renderer.setSize(width, height);
        });
      }

      // --- UI LOGIC: TAB SWITCHING ---
      function switchTab(tabName) {
        const loginForm = document.getElementById("form-login");
        const registerForm = document.getElementById("form-register");
        const loginBtn = document.getElementById("tab-login");
        const registerBtn = document.getElementById("tab-register");
        const errorBox = document.getElementById("global-error");

        // Clear errors when switching
        errorBox.classList.add("hidden");

        if (tabName === "login") {
          loginForm.classList.remove("hidden-tab");
          registerForm.classList.add("hidden-tab");

          loginBtn.classList.add("active-tab-btn");
          loginBtn.classList.remove("inactive-tab-btn");
          registerBtn.classList.remove("active-tab-btn");
          registerBtn.classList.add("inactive-tab-btn");
        } else {
          loginForm.classList.add("hidden-tab");
          registerForm.classList.remove("hidden-tab");

          registerBtn.classList.add("active-tab-btn");
          registerBtn.classList.remove("inactive-tab-btn");
          loginBtn.classList.remove("active-tab-btn");
          loginBtn.classList.add("inactive-tab-btn");
        }
      }

      // --- VALIDATION & ERROR FETCHING ---
      document.addEventListener("DOMContentLoaded", async () => {
        // Start 3D Animation
        initThreeJS();

        const errorDisplay = document.getElementById("global-error");
        const errorText = document.getElementById("error-text");

        function showError(message) {
          errorText.textContent = message;
          errorDisplay.classList.remove("hidden");
        }

        // Check Server Errors (Login)
        try {
          const loginRes = await fetch("/login-error");
          const loginData = await loginRes.json();
          if (loginData.error) {
            switchTab("login");
            showError(loginData.error);
          }
        } catch (e) {
          console.log("No login error or endpoint unavailable");
        }

        // Check Server Errors (Register)
        try {
          const regRes = await fetch("/register-error");
          const regData = await regRes.json();
          if (regData.error) {
            switchTab("register");
            showError(regData.error);
          }
        } catch (e) {
          console.log("No register error or endpoint unavailable");
        }

        // Client Side Validation
        const regForm = document.getElementById("register-form-logic");
        const usernameInput = document.getElementById("reg-username");
        const passInput = document.getElementById("reg-password");
        const confirmPassInput = document.getElementById(
          "reg-confirm-password"
        );

        if (regForm) {
          regForm.addEventListener("submit", function (event) {
            const username = usernameInput.value.trim();
            const password = passInput.value;
            const confirmPassword = confirmPassInput.value;
            let hasError = false;
            let msg = "";

            errorDisplay.classList.add("hidden");

            if (username.length < 6 || username.length > 50) {
              msg = "Tên đăng nhập phải từ 6 đến 50 ký tự!";
              hasError = true;
            } else if (password.length < 6 || password.length > 20) {
              msg = "Mật khẩu phải từ 6 đến 20 ký tự!";
              hasError = true;
            } else if (password !== confirmPassword) {
              msg = "Mật khẩu xác nhận không khớp!";
              passInput.value = "";
              confirmPassInput.value = "";
              hasError = true;
            }

            if (hasError) {
              event.preventDefault();
              showError(msg);
            }
          });
        }
      });
    </script>
  </body>
</html>
